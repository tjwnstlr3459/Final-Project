<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="member">
	<!-- 회원조회 -->
	<select id="selectOneMember"  parameterType="m" resultType="m">
		select member_no as memberNo,
			   email,
			   member_pw as memberPw,
			   member_nick as memberNick,
			   gender,
			   address,
			   intro,
			   hobby1,
			   hobby2,
			   hobby3,
			   filename,
			   filepath,
			   warning_count as warningCount,
			   grade,
			   enroll_date as enrollDate,
			   last_date as lastDate,
			   age,
			   join_method as joinMethod
		from member 
		<if test="email != null">
			where email = #{email} 
		</if>
		<if test="memberPw != null">
			and member_pw=#{memberPw}
		</if>
		<if test="email == null and memberNick != null">
			where member_nick=#{memberNick}
		</if>
	</select>
	<!-- 회원가입 -->
	<insert id="insertMember" parameterType="m">
		insert into member values (member_seq.nextval, #{email}, #{memberPw}, #{memberNick}, #{gender}, #{address}, #{intro}, #{hobby1}, #{hobby2}, #{hobby3},  #{filename}, #{filepath}, 0, 2, to_char(sysdate, 'YYYY-MM-DD'), to_char(sysdate, 'YYYY-MM-DD'), #{age}, #{joinMethod})
	</insert>
	<!-- 전체회원 select -->
	<select id="selectAllMember" parameterType="map" resultType="m">
		select * from (select rownum as sort, m.* from (select member_no as memberNo, email,member_pw as memberPw,member_nick as memberNick,gender,address,intro,hobby1,hobby2,hobby3,grade,warning_count as warningCount, filename,filepath,enroll_date as enrollDate,last_date as lastDate, age from member where grade=2 order by enroll_date)m)where sort between #{start} and #{end}
	</select>
	<update id="updateLastdate" parameterType="map">
		update member set last_date=to_char(sysdate, 'YYYY-MM-DD') where email=#{email}
	</update>
	<!-- 전체회원 수 -->
	<select id="memberCount" resultType="int">
		select count(*) from member
	</select>
	<!-- 회원에서 관리자로 업그레이드 -->  
	<update id="updateGrade" parameterType="map">
		update member set grade=1 where member_no in
		<foreach collection="array" item="memberNo" open="(" close=")" separator=",">
			#{memberNo}
		</foreach>
	</update>
	<!-- 클릭한 회원 삭제 -->
	<delete id="deleteMember" parameterType="string">
		delete from member where member_no=#{memberNo}
	</delete>
	<!-- 이용제한이 끝난 회원 등급을 2로 되돌림 -->
	<update id="updateEndRestMember">
		update member set grade=2 where email in ((select rest_email from restriction where end_date &lt; to_char(sysdate,'yyyy-mm-dd')))
	</update>
</mapper>
